<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>أداة الرسم في تيليجرام</title>
<style>
  body {
    margin: 0;
    font-family: system-ui, sans-serif;
    background: #0d1117;
    color: #fff;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  header {
    padding: 10px;
    background: #161b22;
    text-align: center;
  }
  #toolbar {
    display: flex;
    gap: 8px;
    justify-content: center;
    align-items: center;
    background: #161b22;
    padding: 8px;
    flex-wrap: wrap;
  }
  button, input[type=color], input[type=range] {
    border: none;
    border-radius: 8px;
    padding: 8px;
    font-size: 14px;
    cursor: pointer;
  }
  button {
    background: #238636;
    color: white;
  }
  #clear, #undo {
    background: #d73a49;
  }
  canvas {
    flex: 1;
    touch-action: none;
    background: #fff;
    display: block;
    width: 100%;
    height: 100%;
  }
</style>
</head>
<body>
  <header>🎨 أداة الرسم في تيليجرام</header>
  <div id="toolbar">
    <label>لون:</label> <input type="color" id="color" value="#000000">
    <label>حجم:</label> <input type="range" id="size" min="1" max="50" value="4">
    <button id="undo">↩️ تراجع</button>
    <button id="clear">🗑️ مسح</button>
    <button id="send">📤 إرسال للبوت</button>
  </div>
  <canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let drawing = false;
let paths = [];
let currentPath = [];
let color = document.getElementById('color').value;
let size = document.getElementById('size').value;

// 🔹 تهيئة Telegram WebApp
const isTelegram = window.Telegram && window.Telegram.WebApp;
if (isTelegram) {
  Telegram.WebApp.ready();
  Telegram.WebApp.expand();
}

// ضبط حجم اللوحة تلقائيًا
function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight - document.getElementById('toolbar').offsetHeight - 40;
  redraw();
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

// رسم الخطوط من التاريخ
function redraw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  for (let path of paths) {
    ctx.strokeStyle = path.color;
    ctx.lineWidth = path.size;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.beginPath();
    for (let i = 1; i < path.points.length; i++) {
      const p1 = path.points[i - 1];
      const p2 = path.points[i];
      ctx.moveTo(p1.x, p1.y);
      ctx.lineTo(p2.x, p2.y);
    }
    ctx.stroke();
  }
}

function startDraw(x, y) {
  drawing = true;
  currentPath = { color, size, points: [{ x, y }] };
  paths.push(currentPath);
}
function draw(x, y) {
  if (!drawing) return;
  const p = currentPath.points;
  p.push({ x, y });
  ctx.strokeStyle = currentPath.color;
  ctx.lineWidth = currentPath.size;
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';
  ctx.beginPath();
  const prev = p[p.length - 2];
  ctx.moveTo(prev.x, prev.y);
  ctx.lineTo(x, y);
  ctx.stroke();
}
function endDraw() {
  drawing = false;
  currentPath = [];
}

// 🎨 الأحداث (يعمل باللمس والفأرة)
function getPos(e) {
  const rect = canvas.getBoundingClientRect();
  const touch = e.touches ? e.touches[0] : e;
  return { x: touch.clientX - rect.left, y: touch.clientY - rect.top };
}
canvas.addEventListener('mousedown', e => startDraw(...Object.values(getPos(e))));
canvas.addEventListener('mousemove', e => draw(...Object.values(getPos(e))));
canvas.addEventListener('mouseup', endDraw);
canvas.addEventListener('mouseleave', endDraw);
canvas.addEventListener('touchstart', e => { e.preventDefault(); startDraw(...Object.values(getPos(e))); });
canvas.addEventListener('touchmove', e => { e.preventDefault(); draw(...Object.values(getPos(e))); });
canvas.addEventListener('touchend', endDraw);

// أدوات التحكم
document.getElementById('color').addEventListener('input', e => color = e.target.value);
document.getElementById('size').addEventListener('input', e => size = e.target.value);
document.getElementById('clear').addEventListener('click', () => { paths = []; redraw(); });
document.getElementById('undo').addEventListener('click', () => { paths.pop(); redraw(); });

// زر الإرسال للبوت
document.getElementById('send').addEventListener('click', () => {
  if (paths.length === 0) return alert('🎨 اللوحة فارغة!');
  const dataUrl = canvas.toDataURL('image/png');
  const payload = JSON.stringify({ type: 'drawing', data: dataUrl, timestamp: Date.now() });

  if (isTelegram) {
    Telegram.WebApp.sendData(payload);
    Telegram.WebApp.close(); // يغلق النافذة بعد الإرسال
  } else {
    alert('🚫 افتح هذه الصفحة من داخل تيليجرام لتجربة الإرسال.');
  }
});
</script>
</body>
</html>
