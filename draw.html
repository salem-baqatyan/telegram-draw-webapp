<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÿÆŸÖŸÜ ÿßŸÑÿ±ÿ≥ŸÖÿ© - ÿßÿ±ÿ≥ŸÖ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: var(--tg-theme-bg-color, #f1f1f1);
            color: var(--tg-theme-text-color, #000000);
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }

        /* Container for the drawing area and controls */
        .game-container {
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Word Display */
        .word-display {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
            padding: 8px 15px;
            border-radius: 12px;
            background-color: var(--tg-theme-secondary-bg-color, #e7e7e7);
            color: var(--tg-theme-accent-text-color, #168acd);
        }

        /* Canvas and Frame */
        .canvas-frame {
            border: 1px solid var(--tg-theme-hint-color, #999999);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            touch-action: none; /* Crucial for drawing */
        }

        #drawingCanvas {
            background-color: white;
            display: block;
        }

        /* Controls */
        .controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            padding: 10px;
            background-color: var(--tg-theme-section-bg-color, #ffffff);
            border-radius: 12px;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.05);
        }

        .tool-button {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: none;
            background-color: var(--tg-theme-button-color, #40a7e3);
            color: var(--tg-theme-button-text-color, #ffffff);
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .tool-button:active {
            transform: scale(0.95);
        }
        .tool-button.active {
            background-color: var(--tg-theme-accent-text-color, #168acd);
        }
        .tool-button.color-picker {
            padding: 0;
            overflow: hidden;
        }
        #colorInput {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background: none;
            border: none;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        /* Hide color picker default box */
        #colorInput::-webkit-color-swatch-wrapper { padding: 0; }
        #colorInput::-webkit-color-swatch { border: none; border-radius: 50%; }

        /* Submit Button */
        .submit-button {
            width: 90%;
            margin-top: 20px;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background-color: var(--tg-theme-button-color, #40a7e3);
            color: var(--tg-theme-button-text-color, #ffffff);
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .submit-button:hover {
            opacity: 0.9;
        }

        /* Brush size display */
        .brush-info {
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999);
            border: 2px solid var(--tg-theme-hint-color, #999);
            border-radius: 50%;
        }

    </style>
</head>
<body>
    <div class="game-container">
        <div class="word-display" id="wordDisplay">ÿßŸÑŸÉŸÑŸÖÿ©: ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</div>

        <div class="canvas-frame">
            <canvas id="drawingCanvas" width="400" height="400"></canvas>
        </div>

        <div class="controls">
            <button class="tool-button active" id="penTool" data-tool="pen">‚úèÔ∏è</button>
            <button class="tool-button" id="eraserTool" data-tool="eraser">üßΩ</button>
            <button class="tool-button" id="clearTool">üóëÔ∏è</button>
            <div class="tool-button color-picker">
                <input type="color" id="colorInput" value="#000000">
            </div>
            <div class="brush-info" id="brushInfo">5px</div>
            <input type="range" id="brushSize" min="1" max="50" value="5" style="width: 100%; margin-top: 5px;">
        </div>

        <button class="submit-button" id="submitDrawing">ÿ™ÿ£ŸÉŸäÿØ Ÿàÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ±ÿ≥ŸÖÿ©</button>
    </div>

    <script>
        const Canvas = document.getElementById('drawingCanvas');
        const Ctx = Canvas.getContext('2d');
        const WordDisplay = document.getElementById('wordDisplay');
        const SubmitButton = document.getElementById('submitDrawing');
        const BrushSizeInput = document.getElementById('brushSize');
        const BrushInfo = document.getElementById('brushInfo');
        const ColorInput = document.getElementById('colorInput');
        const Controls = document.querySelector('.controls');
        
        // ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ±ÿ≥ŸÖ
        let isDrawing = false;
        let currentTool = 'pen';
        let currentColor = '#000000';
        let currentSize = 5;
        let lastX = 0;
        let lastY = 0;

        // ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿ±ÿ®ÿ∑ ÿßŸÑÿ®Ÿàÿ™
        let chatId = null;
        let userId = null;
        let secretWord = "ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÉŸÑŸÖÿ©";

        // ------------------------------
        // üõ†Ô∏è ÿ™ŸáŸäÿ¶ÿ© ŸÑŸàÿ≠ÿ© ÿßŸÑÿ±ÿ≥ŸÖ
        // ------------------------------

        function setupCanvas() {
            // ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿÆŸÑŸÅŸäÿ© ÿ®ÿßŸÑŸÑŸàŸÜ ÿßŸÑÿ£ÿ®Ÿäÿ∂
            Ctx.fillStyle = 'white';
            Ctx.fillRect(0, 0, Canvas.width, Canvas.height);

            Ctx.lineCap = 'round';
            Ctx.lineJoin = 'round';
            Ctx.strokeStyle = currentColor;
            Ctx.lineWidth = currentSize;

            // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿ¨ŸÖ ÿßŸÑŸÅÿ±ÿ¥ÿßÿ© ÿßŸÑÿ£ŸàŸÑŸä
            BrushInfo.textContent = `${currentSize}px`;
        }

        // ------------------------------
        // üìå ŸÇÿ±ÿßÿ°ÿ© ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ®Ÿàÿ™ ŸàÿßŸÑŸÉŸÑŸÖÿ©
        // ------------------------------

        function getQueryParams() {
            const params = new URLSearchParams(window.location.search);
            // ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ±Ÿäÿ©
            const encodedWord = params.get('word');
            if (encodedWord) {
                try {
                    // ŸÅŸÉ ÿ™ÿ±ŸÖŸäÿ≤ ÿßŸÑŸÉŸÑŸÖÿ© (ŸÇÿØ ÿ™ŸÉŸàŸÜ ŸÖÿ¥ŸÅÿ±ÿ© ŸÑÿ£ŸÖÿßŸÜ UTF-8)
                    secretWord = decodeURIComponent(encodedWord);
                } catch (e) {
                    console.error("Failed to decode word:", e);
                    secretWord = "ÿÆÿ∑ÿ£ ŸÅŸä ŸÅŸÉ ÿ™ÿ±ŸÖŸäÿ≤ ÿßŸÑŸÉŸÑŸÖÿ©";
                }
            }
            WordDisplay.textContent = `ÿßŸÑŸÉŸÑŸÖÿ©: ${secretWord}`;
            
            // ŸÇÿ±ÿßÿ°ÿ© ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸàÿßŸÑŸÖÿ¨ŸÖŸàÿπÿ© ŸÖŸÜ Telegram WebApp
            if (window.Telegram && window.Telegram.WebApp) {
                const webAppData = window.Telegram.WebApp.initDataUnsafe;
                if (webAppData.user) {
                    userId = webAppData.user.id;
                }
                // ŸÜÿ≠ÿ™ÿßÿ¨ chat_idÿå ÿ®ŸÖÿß ÿ£ŸÜŸÜÿß ŸÜÿ≥ÿ™ÿÆÿØŸÖ Mini App ŸÅŸä ŸÖÿ¨ŸÖŸàÿπÿ©ÿå ŸÜÿ≠ÿµŸÑ ÿπŸÑŸäŸá ŸÖŸÜ start_param
                // ŸÜÿπÿ™ŸÖÿØ ÿπŸÑŸâ ÿ£ŸÜ ÿßŸÑÿ®Ÿàÿ™ ÿ≥ŸäŸÖÿ±ÿ± chat_id ŸÅŸä ŸÖÿπÿßŸÖŸÑ start_param ÿ£Ÿà ÿ≥ŸÜÿπÿ™ŸÖÿØ ÿπŸÑŸâ ÿ£ŸÜ ÿßŸÑÿ®Ÿàÿ™ ŸÑÿØŸäŸá Ÿáÿ∞Ÿá ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™
                // ŸÑŸÉŸÜ ŸÑŸÑÿ£ŸÖÿßŸÜÿå ÿ≥ŸÜÿπÿ™ŸÖÿØ ÿπŸÑŸâ ÿ£ŸÜ ÿßŸÑÿ®Ÿàÿ™ ÿ≥Ÿäÿπÿ±ŸÅ chat_id ŸÖŸÜ ÿÆŸÑÿßŸÑ user_id
                // (ÿ≥ŸÜŸÇŸàŸÖ ÿ®ÿ™ŸÖÿ±Ÿäÿ± chat_id ŸÑÿßÿ≠ŸÇÿßŸã ŸÅŸä ÿßŸÑÿ®Ÿàÿ™ ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸÖÿ™ÿßÿ≠ÿßŸã ŸáŸÜÿß)
                
                // ŸÑŸÜÿ±ÿ≥ŸÑ ÿ®ŸäÿßŸÜÿßÿ™ WebApp.initData ŸÉŸÑŸáÿß ŸÑŸÑÿ®Ÿàÿ™
                // ŸÜŸÉÿ™ŸÅŸä ÿ®ÿßŸÑŸÄ userId ŸÑÿ™ÿ≠ÿØŸäÿØ ŸáŸàŸäÿ© ÿßŸÑÿ±ÿ≥ÿßŸÖ
                console.log("Telegram WebApp Initialized. User ID:", userId);
            }
        }

        // ------------------------------
        // ‚úçÔ∏è Ÿàÿ∏ÿßÿ¶ŸÅ ÿßŸÑÿ±ÿ≥ŸÖ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©
        // ------------------------------

        function draw(e) {
            if (!isDrawing) return;
            
            const rect = Canvas.getBoundingClientRect();
            const scaleX = Canvas.width / rect.width;
            const scaleY = Canvas.height / rect.height;

            let clientX, clientY;
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }

            const x = (clientX - rect.left) * scaleX;
            const y = (clientY - rect.top) * scaleY;
            
            Ctx.beginPath();
            Ctx.moveTo(lastX, lastY);
            Ctx.lineTo(x, y);
            Ctx.stroke();
            
            [lastX, lastY] = [x, y];
        }

        function startDrawing(e) {
            isDrawing = true;
            [lastX, lastY] = getCoordinates(e);
            draw(e); // ŸÑÿ±ÿ≥ŸÖ ŸÜŸÇÿ∑ÿ© ÿπŸÜÿØ ÿßŸÑŸÜŸÇÿ±
        }

        function stopDrawing() {
            isDrawing = false;
        }
        
        function getCoordinates(e) {
            const rect = Canvas.getBoundingClientRect();
            const scaleX = Canvas.width / rect.width;
            const scaleY = Canvas.height / rect.height;

            let clientX, clientY;
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }

            const x = (clientX - rect.left) * scaleX;
            const y = (clientY - rect.top) * scaleY;
            return [x, y];
        }

        // ------------------------------
        // üé® ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ£ÿØŸàÿßÿ™
        // ------------------------------

        function switchTool(tool) {
            currentTool = tool;
            
            Ctx.globalCompositeOperation = (tool === 'eraser') ? 'destination-out' : 'source-over';
            Ctx.strokeStyle = (tool === 'eraser') ? 'rgba(0,0,0,1)' : currentColor;
            
            document.querySelectorAll('.tool-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-tool="${tool}"]`).classList.add('active');
        }

        Controls.addEventListener('click', (e) => {
            const btn = e.target.closest('.tool-button');
            if (!btn) return;

            const tool = btn.dataset.tool;
            if (tool) {
                switchTool(tool);
            } else if (btn.id === 'clearTool') {
                Ctx.clearRect(0, 0, Canvas.width, Canvas.height);
                setupCanvas(); // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿÆŸÑŸÅŸäÿ© ÿßŸÑÿ®Ÿäÿ∂ÿßÿ°
            }
        });

        // ÿ™ÿ∫ŸäŸäÿ± ÿ≠ÿ¨ŸÖ ÿßŸÑŸÅÿ±ÿ¥ÿßÿ©
        BrushSizeInput.addEventListener('input', (e) => {
            currentSize = parseInt(e.target.value);
            Ctx.lineWidth = currentSize;
            BrushInfo.textContent = `${currentSize}px`;
        });
        
        // ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÑŸàŸÜ
        ColorInput.addEventListener('input', (e) => {
            currentColor = e.target.value;
            if (currentTool === 'pen') {
                Ctx.strokeStyle = currentColor;
            }
            // ÿ•ÿπÿßÿØÿ© ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸÇŸÑŸÖ ÿ•ÿ∞ÿß ÿ∫Ÿäÿ± ÿßŸÑŸÑŸàŸÜ ŸàŸÉÿßŸÜ ÿπŸÑŸâ Ÿàÿ∂ÿπ ÿßŸÑŸÖŸÖÿ≠ÿßÿ©
            if (currentTool === 'eraser') {
                switchTool('pen');
            }
        });

        // ------------------------------
        // üöÄ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ±ÿ≥ŸÖÿ© ŸÑŸÑÿ®Ÿàÿ™
        // ------------------------------

        SubmitButton.addEventListener('click', () => {
            // ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿµŸàÿ±ÿ© ŸÉŸÄ Base64
            // Ÿäÿ¨ÿ® ÿ™ÿ¨ÿßŸáŸÑ ÿßŸÑÿ¨ÿ≤ÿ° "data:image/png;base64," ŸÅŸä ÿ≥ŸÑÿ≥ŸÑÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
            const base64Image = Canvas.toDataURL('image/png'); 
            
            // ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿ£ÿ≥ÿßÿ≥Ÿäÿ©
            if (!userId) {
                alert("ÿÆÿ∑ÿ£: ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿ™ÿπÿ±ŸÅ ÿπŸÑŸâ ŸáŸàŸäÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ. Ÿäÿ±ÿ¨Ÿâ ÿ•ÿπÿßÿØÿ© ŸÅÿ™ÿ≠ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ.");
                return;
            }

            // ÿ•ÿπÿØÿßÿØ ŸÉÿßÿ¶ŸÜ JSON ŸÑŸÑÿ•ÿ±ÿ≥ÿßŸÑ (ÿßŸÑÿÆŸäÿßÿ± ÿ®)
            const dataToSend = {
                chat_id: new URLSearchParams(window.location.search).get('chat_id'), // ŸÜÿ≠ÿßŸàŸÑ ŸÇÿ±ÿßÿ°ÿ© chat_id ÿ•ÿ∞ÿß ŸÖÿ±ÿ±Ÿá ÿßŸÑÿ®Ÿàÿ™
                user_id: userId,
                drawing_data: base64Image
            };
            
            // ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑŸÉÿßÿ¶ŸÜ ÿ•ŸÑŸâ ÿ≥ŸÑÿ≥ŸÑÿ© JSON
            const jsonString = JSON.stringify(dataToSend);

            // ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ•ŸÑŸâ ÿßŸÑÿ®Ÿàÿ™ ÿπÿ®ÿ± WebApp API
            if (window.Telegram && window.Telegram.WebApp) {
                // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿ≤ÿ± ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä ŸÇÿ®ŸÑ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ (ÿ£ŸÖÿ± ÿ¨ŸäÿØ ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ)
                window.Telegram.WebApp.MainButton.hide(); 
                
                // ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                window.Telegram.WebApp.sendData(jsonString);
                
                // ÿ•ÿ∫ŸÑÿßŸÇ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑŸàŸäÿ® (ÿ£Ÿà ÿ•ÿ∏Ÿáÿßÿ± ÿ±ÿ≥ÿßŸÑÿ© ŸÜÿ¨ÿßÿ≠)
                window.Telegram.WebApp.close();
            } else {
                alert("Telegram WebApp API ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±. ŸÑÿß ŸäŸÖŸÉŸÜ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ±ÿ≥ŸÖÿ©.");
            }
        });

        // ------------------------------
        // ‚öôÔ∏è ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
        // ------------------------------
        
        window.onload = () => {
            if (window.Telegram && window.Telegram.WebApp) {
                // ÿ™ŸáŸäÿ¶ÿ© ÿ™ÿµŸÖŸäŸÖ ÿßŸÑÿ®Ÿàÿ™
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.setHeaderColor('bg_color'); // ŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÑŸàŸÜ ÿÆŸÑŸÅŸäÿ© ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
                window.Telegram.WebApp.expand(); // ÿ™Ÿàÿ≥Ÿäÿπ ÿßŸÑŸàÿßÿ¨Ÿáÿ© ŸÑŸÖŸÑÿ° ÿßŸÑÿ¥ÿßÿ¥ÿ©
                
                // ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ≤ÿ± ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä (ÿßÿÆÿ™Ÿäÿßÿ±Ÿäÿå ŸäŸÖŸÉŸÜŸÜÿß ÿßŸÑÿßÿπÿ™ŸÖÿßÿØ ÿπŸÑŸâ ÿ≤ÿ± HTML)
                // window.Telegram.WebApp.MainButton.setText('ÿ™ÿ£ŸÉŸäÿØ Ÿàÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ±ÿ≥ŸÖÿ©');
                // window.Telegram.WebApp.MainButton.show();
                // window.Telegram.WebApp.MainButton.onClick(submitDrawing);
            }
            
            // ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÉŸÑŸÖÿ© ŸàÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
            getQueryParams();
            
            // ÿ™ŸáŸäÿ¶ÿ© ŸÑŸàÿ≠ÿ© ÿßŸÑÿ±ÿ≥ŸÖ
            setupCanvas();
            
            // ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ŸÖÿπÿßÿ™ ÿßŸÑÿ£ÿ≠ÿØÿßÿ´ (ÿßŸÑÿ±ÿ≥ŸÖ ÿ®ÿßŸÑŸÖÿßŸàÿ≥ ŸàÿßŸÑŸÑŸÖÿ≥)
            Canvas.addEventListener('mousedown', startDrawing);
            Canvas.addEventListener('mousemove', draw);
            Canvas.addEventListener('mouseup', stopDrawing);
            Canvas.addEventListener('mouseout', stopDrawing);

            Canvas.addEventListener('touchstart', (e) => {
                e.preventDefault(); // ŸÖŸÜÿπ ÿ≥ŸÑŸàŸÉŸäÿßÿ™ ÿßŸÑŸÑŸÖÿ≥ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© ŸÖÿ´ŸÑ ÿßŸÑÿ™ŸÖÿ±Ÿäÿ±
                startDrawing(e);
            }, { passive: false });
            Canvas.addEventListener('touchmove', (e) => {
                e.preventDefault(); 
                draw(e);
            }, { passive: false });
            Canvas.addEventListener('touchend', stopDrawing);
        };
    </script>
</body>
</html>
