<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>خمن الرسمة - ارسم</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* CSS لتقليد تصميم DoodleGator (ألوان Telegram Mini App) */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: var(--tg-theme-bg-color, #f1f1f1);
            color: var(--tg-theme-text-color, #000000);
            min-height: 100vh;
        }

        .header {
            width: 100%;
            text-align: center;
            padding: 15px 0;
        }

        .word-display {
            font-size: 24px;
            font-weight: bold;
            color: var(--tg-theme-link-color, #168acd);
        }

        .canvas-container {
            width: 90%;
            max-width: 500px;
            aspect-ratio: 1 / 1; /* لجعلها مربعة */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            overflow: hidden;
            background-color: white;
            margin-bottom: 20px;
        }

        #drawingCanvas {
            width: 100%;
            height: 100%;
            touch-action: none; /* لمنع التمرير أثناء الرسم على الجوال */
        }

        .controls-panel {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            background-color: var(--tg-theme-secondary-bg-color, #ffffff);
            width: 100%;
            box-sizing: border-box;
            border-top: 1px solid var(--tg-theme-section-separator-color, #e7e7e7);
        }

        .control-button {
            background-color: var(--tg-theme-button-color, #40a7e3);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .control-button.active {
            background-color: var(--tg-theme-accent-text-color, #168acd);
        }
        
        /* أدوات الخط واللون */
        .settings-row {
            width: 90%;
            max-width: 500px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 0 15px 0;
        }

        #colorPicker {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 45px;
            height: 45px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            padding: 0;
            overflow: hidden;
            background: transparent;
        }

        #colorPicker::-webkit-color-swatch {
            border: none;
            border-radius: 50%;
        }

        #colorPicker::-moz-color-swatch {
            border: none;
            border-radius: 50%;
        }

        #penSizeSlider {
            width: 70%;
            -webkit-appearance: none;
            height: 8px;
            background: var(--tg-theme-hint-color, #999999);
            border-radius: 4px;
        }

        #penSizeSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--tg-theme-button-color, #40a7e3);
            cursor: pointer;
        }
        #confirmButton {
            width: 90%;
            max-width: 500px;
            margin-top: 15px;
            height: 50px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="header">
        <span class="word-display" id="wordToDraw">تحميل...</span>
    </div>

    <div class="settings-row">
        <button id="undoButton" class="control-button" title="تراجع">↩️</button>
        <button id="redoButton" class="control-button" title="إعادة">↪️</button>
        <input type="range" id="penSizeSlider" min="2" max="30" value="7">
        <input type="color" id="colorPicker" value="#000000" title="لون">
    </div>

    <div class="canvas-container">
        <canvas id="drawingCanvas"></canvas>
    </div>

    <div class="controls-panel">
        <button id="penButton" class="control-button active" title="قلم">✏️</button>
        <button id="eraserButton" class="control-button" title="ممحاة">🧼</button>
        <button id="clearButton" class="control-button" title="مسح اللوحة">❌</button>
        <button id="sendDrawingButton" class="control-button" title="أكيد، أرسل!">✅</button>
    </div>
    
    <button id="confirmButton" class="control-button" onclick="sendDrawing()">أرسل الرسمة للقروب</button>

    <script>
        const canvas = document.getElementById('drawingCanvas');
        const ctx = canvas.getContext('2d');
        const wordToDrawElement = document.getElementById('wordToDraw');
        const penButton = document.getElementById('penButton');
        const eraserButton = document.getElementById('eraserButton');
        const clearButton = document.getElementById('clearButton');
        const colorPicker = document.getElementById('colorPicker');
        const penSizeSlider = document.getElementById('penSizeSlider');
        const undoButton = document.getElementById('undoButton');
        const redoButton = document.getElementById('redoButton');

        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let history = []; // لسجل التراجع/التقديم
        let historyIndex = -1;
        let isErasing = false;
        let currentSize = parseInt(penSizeSlider.value);
        let currentColor = colorPicker.value;

        // إعدادات البوت والقيم المستلمة
        let chatId = null;
        let userId = null;
        let secretWord = "الكلمة"; // قيمة افتراضية

        // ------------------------------
        // 1. تهيئة البوت وقراءة البيانات
        // ------------------------------

        document.addEventListener('DOMContentLoaded', () => {
            // تهيئة واجهة Web App
            if (window.Telegram && window.Telegram.WebApp) {
                Telegram.WebApp.ready();
                // إخفاء زر Close الافتراضي لكي نستخدم زر التأكيد في الأسفل
                Telegram.WebApp.BackButton.hide();
                Telegram.WebApp.MainButton.hide();

                // قراءة البيانات من URL (التي مررناها كبارامترات)
                const urlParams = new URLSearchParams(window.location.search);
                
                secretWord = urlParams.get('word') || "خطأ: الكلمة مفقودة";
                chatId = urlParams.get('chat_id');
                userId = urlParams.get('user_id');

                wordToDrawElement.textContent = secretWord;
            }

            // لجعل Canvas يملأ مربع الحاوية دائمًا
            const container = document.querySelector('.canvas-container');
            const size = container.offsetWidth;
            canvas.width = size;
            canvas.height = size;
            
            // إعدادات الرسم الأولية
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';
            ctx.lineWidth = currentSize;
            ctx.strokeStyle = currentColor;
            
            // إضافة خلفية بيضاء لكي يمكن تحويلها لـ PNG بشكل صحيح
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            saveState(); // حفظ حالة اللوحة الأولية

            // ربط الأحداث
            attachEventListeners();
        });


        // ------------------------------
        // 2. دوال الرسم الأساسية
        // ------------------------------

        function draw(e) {
            if (!isDrawing) return;
            
            // الحصول على إحداثيات اللمس/الماوس بالنسبة للـ Canvas
            const rect = canvas.getBoundingClientRect();
            let clientX, clientY;
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }

            const x = (clientX - rect.left) * (canvas.width / rect.width);
            const y = (clientY - rect.top) * (canvas.height / rect.height);
            
            ctx.lineWidth = currentSize;
            ctx.strokeStyle = isErasing ? 'white' : currentColor;
            
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.stroke();

            [lastX, lastY] = [x, y];
        }

        function startDrawing(e) {
            isDrawing = true;
            
            // تحديد نقطة البداية
            const rect = canvas.getBoundingClientRect();
            let clientX, clientY;
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }

            const x = (clientX - rect.left) * (canvas.width / rect.width);
            const y = (clientY - rect.top) * (canvas.height / rect.height);
            
            [lastX, lastY] = [x, y];
        }

        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                saveState();
            }
        }

        function attachEventListeners() {
            // Mouse Events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            // Touch Events (للهواتف)
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault(); // منع سلوك اللمس الافتراضي (التمرير)
                startDrawing(e);
            });
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                draw(e);
            });
            canvas.addEventListener('touchend', stopDrawing);

            // تحكم الأدوات
            colorPicker.addEventListener('change', (e) => {
                currentColor = e.target.value;
                if (!isErasing) ctx.strokeStyle = currentColor;
                penButton.classList.add('active');
                eraserButton.classList.remove('active');
                isErasing = false;
            });
            
            penSizeSlider.addEventListener('input', (e) => {
                currentSize = parseInt(e.target.value);
            });

            penButton.addEventListener('click', () => {
                isErasing = false;
                penButton.classList.add('active');
                eraserButton.classList.remove('active');
            });

            eraserButton.addEventListener('click', () => {
                isErasing = true;
                penButton.classList.remove('active');
                eraserButton.classList.add('active');
            });

            clearButton.addEventListener('click', clearCanvas);

            undoButton.addEventListener('click', undo);
            redoButton.addEventListener('click', redo);
        }

        // ------------------------------
        // 3. التراجع والحفظ
        // ------------------------------

        function saveState() {
            // إذا كنا قد تراجعنا، سنحذف أي خطوات لاحقة (Redo history)
            if (historyIndex < history.length - 1) {
                history = history.slice(0, historyIndex + 1);
            }
            
            // نحفظ اللوحة كـ Base64
            const dataURL = canvas.toDataURL();
            history.push(dataURL);
            historyIndex++;
        }

        function restoreState(index) {
            if (index < 0 || index >= history.length) return;
            
            const img = new Image();
            img.onload = () => {
                // نعيد الرسم على لوحة بيضاء أولاً لضمان الوضوح
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            };
            img.src = history[index];
            historyIndex = index;
        }

        function undo() {
            if (historyIndex > 0) {
                restoreState(historyIndex - 1);
            }
        }

        function redo() {
            if (historyIndex < history.length - 1) {
                restoreState(historyIndex + 1);
            }
        }

        function clearCanvas() {
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            saveState();
        }


        // ------------------------------
        // 4. إرسال الرسمة إلى البوت
        // ------------------------------
        
        function sendDrawing() {
            if (!Telegram.WebApp || !Telegram.WebApp.sendData) {
                alert("واجهة تيليجرام غير متاحة أو غير مهيئة بشكل صحيح.");
                return;
            }

            if (!chatId || !userId || secretWord === "خطأ: الكلمة مفقودة") {
                 alert("خطأ في بيانات الجلسة. الرجاء التأكد من فتح الرابط من البوت.");
                 return;
            }

            // تحويل الرسمة إلى Base64
            const drawingDataURL = canvas.toDataURL('image/png');
            
            // تهيئة بيانات JSON
            const data = {
                chat_id: chatId,
                user_id: userId,
                drawing_data: drawingDataURL 
            };
            
            try {
                // إرسال البيانات إلى البوت
                Telegram.WebApp.sendData(JSON.stringify(data));
                
                // إغلاق نافذة الويب (أو رسالة تأكيد)
                alert("تم إرسال الرسمة بنجاح! يمكنك إغلاق النافذة.");
                Telegram.WebApp.close();
            } catch (e) {
                alert("حدث خطأ أثناء إرسال البيانات: " + e.message);
            }
        }
    </script>
</body>
</html>
